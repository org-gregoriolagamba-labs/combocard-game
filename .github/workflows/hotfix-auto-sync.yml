name: Hotfix auto sync main -> develop

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  auto-sync:
    if: >
      github.event.pull_request.merged == true &&
      contains(join(github.event.pull_request.labels.*.name, ','), 'hotfix')
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_PAT }}   # PAT con permessi repo completo

    steps:
      - name: Setup Octokit with PAT
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            console.log(`Hotfix merged: ${pr.html_url}`);

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Inizializza Octokit con PAT
            const octokit = github.getOctokit(process.env.GH_TOKEN);

            // 1️⃣ Controlla se esiste già una PR aperta main -> develop
            const { data: existingPRs } = await octokit.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              base: 'develop',
              head: `${owner}:main`
            });

            if (existingPRs.length > 0) {
              console.log('Sync PR already exists:', existingPRs[0].html_url);
              return;
            }

            // 2️⃣ Crea la PR di sync
            const syncTitle = `Sync main into develop (hotfix #${pr.number})`;
            const syncBody = `Questa PR è stata creata automaticamente dopo il merge di un hotfix. Hotfix PR: ${pr.html_url} ⚠️ Questa PR fa parte integrante del workflow hotfix.`;

            const syncPR = await octokit.rest.pulls.create({
              owner,
              repo,
              base: 'develop',
              head: 'main',
              title: syncTitle,
              body: syncBody
            });

            console.log('Sync PR created:', syncPR.data.html_url);
